<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ë³´í—˜ ê³ ê° ê´€ë¦¬</title>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#f0f4f8;--surface:#fff;--surface2:#f8fafc;
  --primary:#1e40af;--primary-light:#3b82f6;--primary-bg:#eff6ff;
  --success:#10b981;--warning:#f59e0b;--danger:#ef4444;
  --border:#e2e8f0;--text:#1e293b;--muted:#64748b;--subtle:#94a3b8;
  --shadow:0 2px 8px rgba(0,0,0,.08);--shadow-lg:0 8px 32px rgba(0,0,0,.14);
  --header-h:56px;--bottom-h:64px;
}
body{font-family:'Pretendard',sans-serif;background:var(--bg);color:var(--text);font-size:14px;line-height:1.5;overflow-x:hidden}

/* â•â• HEADER â•â• */
.app-header{
  background:linear-gradient(135deg,#1e3a8a 0%,#1e40af 60%,#2563eb 100%);
  color:#fff;padding:0 16px;display:flex;align-items:center;gap:10px;
  height:var(--header-h);position:fixed;top:0;left:0;right:0;z-index:300;
  box-shadow:0 2px 12px rgba(30,64,175,.45);
}
.app-logo{font-size:1.05rem;font-weight:700;display:flex;align-items:center;gap:7px;flex:1}
.header-actions{display:flex;gap:6px}
.icon-btn{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);color:#fff;width:36px;height:36px;border-radius:9px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;transition:all .2s}
.icon-btn:hover,.icon-btn:active{background:rgba(255,255,255,.3)}

/* â•â• MAIN SCROLL AREA â•â• */
.main-scroll{padding-top:var(--header-h);padding-bottom:var(--bottom-h);min-height:100vh}

/* â•â• STATS â•â• */
.stats-bar{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;padding:12px 14px;background:#fff;border-bottom:1px solid var(--border)}
@media(min-width:600px){.stats-bar{grid-template-columns:repeat(4,1fr);}}
.stat-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:9px}
.stat-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.stat-icon.blue{background:#eff6ff}.stat-icon.green{background:#ecfdf5}.stat-icon.yellow{background:#fffbeb}.stat-icon.red{background:#fef2f2}
.stat-val{font-size:1.25rem;font-weight:700;line-height:1}
.stat-lbl{font-size:.68rem;color:var(--muted);margin-top:1px}

/* â•â• ALERT BAR â•â• */
.alert-bar{background:#fffbeb;border-bottom:1px solid #fde68a;padding:9px 14px;display:none;align-items:flex-start;gap:8px;flex-wrap:wrap}
.alert-bar.show{display:flex}
.alert-bar-text{font-size:.8rem;font-weight:600;color:#92400e;white-space:nowrap;margin-top:2px}
.alert-chip{background:#fef9c3;border:1px solid #fde68a;border-radius:99px;padding:2px 9px;font-size:.73rem;color:#854d0e;font-weight:500;margin:2px}

/* â•â• TOOLBAR â•â• */
.toolbar{display:flex;align-items:center;gap:8px;padding:10px 14px;background:#fff;border-bottom:1px solid var(--border);position:sticky;top:var(--header-h);z-index:100}
.search-box{display:flex;align-items:center;gap:7px;background:var(--bg);border:1px solid var(--border);border-radius:9px;padding:8px 12px;flex:1}
.search-box input{border:none;background:none;outline:none;width:100%;font-size:.88rem;color:var(--text);font-family:inherit}
.search-box input::placeholder{color:var(--subtle)}
.filter-btn{background:var(--bg);border:1px solid var(--border);border-radius:9px;padding:8px 10px;font-size:.8rem;color:var(--muted);cursor:pointer;white-space:nowrap;display:flex;align-items:center;gap:4px}
.filter-btn.active{background:var(--primary-bg);border-color:var(--primary-light);color:var(--primary);font-weight:600}

/* â•â• FILTER PILLS (mobile) â•â• */
.filter-pills{display:flex;gap:6px;padding:8px 14px;overflow-x:auto;scrollbar-width:none;background:#fff;border-bottom:1px solid var(--border)}
.filter-pills::-webkit-scrollbar{display:none}
.pill{padding:5px 13px;border-radius:99px;border:1.5px solid var(--border);font-size:.78rem;font-weight:600;cursor:pointer;white-space:nowrap;background:#fff;color:var(--muted);transition:all .15s}
.pill.active{background:var(--primary);border-color:var(--primary);color:#fff}

/* â•â• VIEW TOGGLE â•â• */
.view-toggle{display:flex;gap:0;background:var(--bg);border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-right:4px}
.view-btn{padding:7px 9px;border:none;background:none;cursor:pointer;color:var(--muted);font-size:.85rem;transition:all .15s}
.view-btn.active{background:#fff;color:var(--primary);box-shadow:0 1px 4px rgba(0,0,0,.1)}

/* â•â• CARD LIST (mobile default) â•â• */
.card-list{display:flex;flex-direction:column;gap:10px;padding:12px 14px}
.customer-card{background:#fff;border-radius:14px;border:1px solid var(--border);box-shadow:var(--shadow);overflow:hidden;cursor:pointer;transition:all .18s;-webkit-user-select:none;user-select:none}
.customer-card:active{transform:scale(.98);box-shadow:none}

.card-top{padding:14px 14px 10px;display:flex;align-items:flex-start;gap:12px}
.card-avatar{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:700;color:#fff;flex-shrink:0;font-family:'Pretendard',sans-serif}
.card-main{flex:1;min-width:0}
.card-name-row{display:flex;align-items:center;gap:8px;margin-bottom:2px}
.card-name{font-size:1rem;font-weight:700}
.card-phone{font-size:.8rem;color:var(--muted);margin-top:1px}
a.tel-link{color:inherit;text-decoration:none;display:inline-flex;align-items:center;gap:3px}
a.tel-link:hover{color:var(--primary);text-decoration:underline}
a.tel-link:active{opacity:.7}
.card-job{font-size:.75rem;color:var(--subtle)}

.badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:99px;font-size:.69rem;font-weight:700}
.badge-active{background:#dcfce7;color:#15803d}
.badge-renewal{background:#fef3c7;color:#92400e;animation:blink-badge 2s infinite}
.badge-expired{background:#fee2e2;color:#991b1b}
.badge-fam{background:#ede9fe;color:#5b21b6;font-size:.68rem;padding:1px 6px}
@keyframes blink-badge{0%,100%{opacity:1}50%{opacity:.6}}
.alert-dot{width:7px;height:7px;border-radius:50%;background:var(--danger);display:inline-block;margin-left:3px;animation:blink-dot 1.4s infinite;vertical-align:middle}
@keyframes blink-dot{0%,100%{opacity:1}50%{opacity:.1}}

.card-divider{height:1px;background:var(--border);margin:0 14px}

.card-section{padding:10px 14px}
.card-section-title{font-size:.68rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:7px;display:flex;align-items:center;gap:5px}

/* Insurance pills in card */
.ins-list{display:flex;flex-direction:column;gap:5px}
.ins-row{display:flex;align-items:center;justify-content:space-between;gap:8px;background:var(--surface2);border-radius:8px;padding:7px 10px;border:1px solid var(--border)}
.ins-row.alert-ins{border-left:3px solid var(--danger)}
.ins-info{flex:1;min-width:0}
.ins-name{font-size:.83rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ins-detail{font-size:.73rem;color:var(--muted);margin-top:1px}
.ins-price{font-size:.82rem;font-weight:700;color:var(--primary);white-space:nowrap}
.ins-total{font-size:.78rem;font-weight:700;color:var(--primary);text-align:right;margin-top:5px}

/* Family pills */
.fam-pills{display:flex;flex-wrap:wrap;gap:5px}
.fam-pill{background:#f5f3ff;border:1px solid #ddd6fe;border-radius:8px;padding:5px 9px;font-size:.75rem}
.fam-pill .fam-name{font-weight:700;color:#4c1d95}
.fam-pill .fam-rel{color:#7c3aed;margin-left:3px}
.fam-pill .fam-info{color:var(--muted);font-size:.7rem;display:block;margin-top:1px}

/* Car/silseon row */
.info-row{display:flex;flex-wrap:wrap;gap:6px}
.info-chip{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:5px 10px;font-size:.76rem;display:flex;align-items:center;gap:5px}
.info-chip.alert-chip-red{border-color:#fecaca;background:#fef2f2}
.info-chip .chip-label{color:var(--muted);font-size:.68rem}
.info-chip .chip-val{font-weight:600;color:var(--text)}

.card-actions{padding:0 14px 14px;display:flex;gap:7px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:5px;padding:8px 14px;border-radius:9px;cursor:pointer;font-size:.84rem;font-weight:600;border:none;transition:all .15s;white-space:nowrap;font-family:inherit}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:active{background:#1d4ed8}
.btn-outline{background:#fff;color:var(--primary);border:1px solid var(--border)}
.btn-outline:active{background:var(--primary-bg)}
.btn-danger{background:#fee2e2;color:var(--danger);border:1px solid #fecaca}
.btn-danger:active{background:#fecaca}
.btn-sm{padding:7px 12px;font-size:.8rem}
.btn-full{width:100%}

/* â•â• TABLE VIEW (desktop) â•â• */
.table-view{display:none}
.table-wrap{overflow-x:auto;background:#fff}
table.main-table{width:100%;border-collapse:collapse;min-width:980px}
.main-table thead tr{background:linear-gradient(to bottom,#f8fafc,#f1f5f9);border-bottom:2px solid var(--border)}
.main-table th{padding:10px 12px;text-align:left;font-size:.7rem;font-weight:700;color:var(--muted);letter-spacing:.05em;text-transform:uppercase;white-space:nowrap;cursor:pointer;user-select:none}
.main-table th:hover{color:var(--primary)}
.main-table tbody tr{border-bottom:1px solid var(--border);transition:background .1s;cursor:pointer}
.main-table tbody tr:hover{background:#f8fafc}
.main-table td{padding:9px 12px;font-size:.83rem;vertical-align:top}
.ins-mini{display:flex;flex-direction:column;gap:3px}
.ins-mini-row{font-size:.74rem;background:#f8fafc;border-left:3px solid var(--border);border-radius:0 4px 4px 0;padding:3px 8px;white-space:nowrap}
.ins-mini-row.alert{border-left-color:var(--danger)}
.ins-mini-row .co{font-weight:700}
.ins-total-t{font-size:.72rem;color:var(--primary);font-weight:700;margin-top:3px}

/* â•â• EMPTY â•â• */
.empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
.empty-icon{font-size:3rem;margin-bottom:12px;opacity:.4}
.empty-text{font-size:.95rem;font-weight:600;margin-bottom:6px}
.empty-sub{font-size:.82rem;color:var(--subtle)}

/* â•â• BOTTOM NAV (mobile FAB) â•â• */
.fab{
  position:fixed;bottom:calc(var(--bottom-h) - 20px);right:16px;z-index:200;
  width:56px;height:56px;border-radius:50%;
  background:linear-gradient(135deg,var(--primary),var(--primary-light));
  color:#fff;border:none;cursor:pointer;
  box-shadow:0 4px 16px rgba(30,64,175,.45);
  display:flex;align-items:center;justify-content:center;font-size:1.5rem;
  transition:all .2s;
}
.fab:active{transform:scale(.92)}
.bottom-bar{
  position:fixed;bottom:0;left:0;right:0;height:var(--bottom-h);z-index:200;
  background:#fff;border-top:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-around;
  padding:0 10px;padding-bottom:env(safe-area-inset-bottom,0px);
}
.bottom-btn{display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 14px;border:none;background:none;cursor:pointer;color:var(--muted);font-size:.65rem;font-weight:600;font-family:inherit;transition:color .15s;min-width:55px}
.bottom-btn .bb-icon{font-size:1.2rem}
.bottom-btn.active{color:var(--primary)}

/* â•â• MODAL â•â• */
.modal-overlay{position:fixed;inset:0;background:rgba(15,23,42,.55);z-index:500;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(3px)}
.modal-overlay.open{display:flex}
.modal{
  background:#fff;border-radius:20px 20px 0 0;width:100%;
  max-height:92vh;overflow-y:auto;box-shadow:var(--shadow-lg);
  animation:slideUp .28s cubic-bezier(.34,1.56,.64,1);
  padding-bottom:env(safe-area-inset-bottom,16px);
}
@media(min-width:640px){
  .modal-overlay{align-items:center}
  .modal{border-radius:16px;max-width:820px;max-height:90vh}
}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:36px;height:4px;background:var(--border);border-radius:99px;margin:12px auto 0}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#fff;z-index:10}
.modal-title{font-size:.98rem;font-weight:700}
.modal-close{width:30px;height:30px;border:none;background:var(--bg);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:.9rem}
.modal-body{padding:16px 18px}
.modal-footer{padding:12px 18px;border-top:1px solid var(--border);display:flex;gap:8px;background:#fff;position:sticky;bottom:0}

/* â•â• FORM â•â• */
.form-section{margin-bottom:20px}
.form-section-title{font-size:.72rem;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.08em;margin-bottom:11px;padding-bottom:7px;border-bottom:2px solid var(--primary-bg)}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.form-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
@media(max-width:480px){.form-grid{grid-template-columns:1fr}.form-grid-3{grid-template-columns:1fr 1fr}}
.form-group{display:flex;flex-direction:column;gap:4px}
.form-group.full{grid-column:1/-1}
label{font-size:.76rem;font-weight:600;color:var(--muted)}
input[type=text],input[type=tel],input[type=date],input[type=number],input[type=email],select,textarea{
  border:1.5px solid var(--border);border-radius:9px;padding:10px 12px;font-size:.9rem;
  outline:none;width:100%;color:var(--text);background:#fff;
  transition:border-color .14s,box-shadow .14s;font-family:inherit;-webkit-appearance:none;
}
input:focus,select:focus,textarea:focus{border-color:var(--primary-light);box-shadow:0 0 0 3px rgba(59,130,246,.11)}
textarea{resize:none;min-height:70px}
.ssn-row{display:grid;grid-template-columns:1fr auto 1fr;gap:6px;align-items:center}
.ssn-dash{color:var(--muted);font-weight:700;text-align:center;font-size:1.1rem}

/* â•â• DYNAMIC TABLE â•â• */
.dyn-block{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.dyn-row{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;position:relative}
.dyn-row-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media(min-width:600px){.dyn-row-grid.ins-grid{grid-template-columns:1fr 1fr 1fr}}
.dyn-row .del-row-btn{position:absolute;top:8px;right:8px;width:26px;height:26px;border:none;background:#fee2e2;color:var(--danger);border-radius:7px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.8rem}
.dyn-row .del-row-btn:active{background:#fecaca}
.add-row-btn{display:flex;align-items:center;justify-content:center;gap:6px;padding:10px;background:none;border:1.5px dashed var(--primary-light);border-radius:10px;color:var(--primary);font-size:.83rem;font-weight:600;cursor:pointer;width:100%;font-family:inherit;transition:all .15s}
.add-row-btn:active{background:var(--primary-bg)}

/* MEMO */
.memo-list{display:flex;flex-direction:column;gap:7px;margin-top:8px}
.memo-item{background:var(--surface2);border:1px solid var(--border);border-left:3px solid var(--primary-light);border-radius:9px;padding:10px 12px;position:relative}
.memo-date{font-size:.69rem;color:var(--subtle);margin-bottom:3px}
.memo-text{font-size:.84rem;line-height:1.5;padding-right:28px}
.memo-del{position:absolute;top:8px;right:8px;background:none;border:none;color:var(--subtle);cursor:pointer;font-size:.8rem;padding:3px 6px;border-radius:5px}
.memo-del:active{background:#fee2e2;color:var(--danger)}
.memo-add-row{display:flex;flex-direction:column;gap:7px;margin-top:8px}

/* TOAST */
.toast{position:fixed;bottom:calc(var(--bottom-h) + 12px);left:50%;transform:translateX(-50%) translateY(80px);background:#1e293b;color:#fff;padding:11px 20px;border-radius:99px;font-size:.84rem;font-weight:500;z-index:9999;opacity:0;transition:all .28s;white-space:nowrap;box-shadow:var(--shadow-lg)}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.toast.success{background:#059669}
.toast.warning{background:#d97706}

/* PAGINATION */
.pagination{display:flex;align-items:center;justify-content:center;gap:6px;padding:14px;background:#fff;border-top:1px solid var(--border)}
.page-btn{width:34px;height:34px;border:1px solid var(--border);background:#fff;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.82rem;font-weight:600}
.page-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.page-count{font-size:.8rem;color:var(--muted);padding:0 8px}

/* DETAIL SHEET */
.detail-overlay{position:fixed;inset:0;background:rgba(15,23,42,.55);z-index:600;display:none;backdrop-filter:blur(3px)}
.detail-overlay.open{display:block}
.detail-sheet{position:fixed;bottom:0;left:0;right:0;max-height:94vh;overflow-y:auto;background:#fff;border-radius:20px 20px 0 0;z-index:601;animation:slideUp .28s cubic-bezier(.34,1.56,.64,1);padding-bottom:env(safe-area-inset-bottom,20px)}
@media(min-width:640px){
  .detail-sheet{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:100%;max-width:700px;max-height:88vh;border-radius:16px;animation:none}
}
.detail-handle{width:36px;height:4px;background:var(--border);border-radius:99px;margin:12px auto 0}
.detail-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;position:sticky;top:0;background:#fff;z-index:10}
.detail-avatar{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:700;color:#fff;flex-shrink:0}
.detail-name{font-size:1.05rem;font-weight:700}
.detail-sub{font-size:.78rem;color:var(--muted)}
.detail-close{margin-left:auto;width:30px;height:30px;border:none;background:var(--bg);border-radius:8px;cursor:pointer;color:var(--muted);font-size:.9rem;display:flex;align-items:center;justify-content:center}
.detail-body{padding:14px 18px;display:flex;flex-direction:column;gap:16px}
.detail-section-title{font-size:.7rem;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px;padding-bottom:6px;border-bottom:1.5px solid var(--primary-bg)}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.detail-field{background:var(--surface2);border-radius:8px;padding:8px 10px}
.detail-field .d-label{font-size:.68rem;color:var(--muted);font-weight:600;margin-bottom:2px}
.detail-field .d-val{font-size:.85rem;font-weight:500;word-break:break-all}
.detail-footer{padding:12px 18px;border-top:1px solid var(--border);display:flex;gap:8px;position:sticky;bottom:0;background:#fff}


/* â•â• BACKUP MODAL â•â• */
.btab{flex:1;padding:9px;border:none;border-radius:8px;font-size:.88rem;font-weight:600;cursor:pointer;font-family:inherit;background:none;color:var(--muted);transition:all .15s}
.btab-active{background:var(--primary);color:#fff}
.backup-code-box{background:#1e293b;color:#e2e8f0;border-radius:10px;padding:14px;font-family:monospace;font-size:.72rem;word-break:break-all;line-height:1.6;max-height:120px;overflow-y:auto;user-select:all;-webkit-user-select:all;cursor:text;border:1px solid #334155}
.backup-action-btn{display:flex;align-items:center;justify-content:center;gap:7px;padding:12px;border-radius:10px;border:none;font-size:.9rem;font-weight:600;cursor:pointer;width:100%;font-family:inherit;transition:all .15s}
.backup-action-btn:active{opacity:.8}
.restore-input{width:100%;border:1.5px solid var(--border);border-radius:10px;padding:12px;font-family:monospace;font-size:.75rem;resize:none;height:110px;outline:none;line-height:1.5}
.restore-input:focus{border-color:var(--primary-light)}

@media print{.app-header,.bottom-bar,.fab,.toolbar,.stats-bar,.alert-bar,.modal-overlay,.detail-overlay,.toast{display:none!important}.card-list{gap:0}.customer-card{border-radius:0;box-shadow:none;border:none;border-bottom:1px solid #ccc}}
</style>
</head>
<body>

<!-- ë¡œë”© í™”ë©´ -->
<div id="loadingScreen" style="position:fixed;inset:0;background:#1e40af;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;color:#fff">
  <div style="font-size:3rem">ğŸ›¡ï¸</div>
  <div style="font-size:1.15rem;font-weight:700">ë³´í—˜ ê³ ê° ê´€ë¦¬</div>
  <div class="ld-msg" style="font-size:.85rem;opacity:.7">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>
  <div style="width:44px;height:44px;border:4px solid rgba(255,255,255,.25);border-top-color:#fff;border-radius:50%;animation:ldSpin .8s linear infinite;margin-top:4px"></div>
</div>
<style>@keyframes ldSpin{to{transform:rotate(360deg)}}</style>

<!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… í™”ë©´ -->
<div id="authScreen" style="display:none;position:fixed;inset:0;background:linear-gradient(135deg,#1e3a8a,#1e40af,#2563eb);z-index:8000;flex-direction:column;align-items:center;justify-content:center;padding:24px;overflow-y:auto">
  <div style="width:100%;max-width:380px">
    <div style="text-align:center;margin-bottom:28px">
      <div style="font-size:2.8rem;margin-bottom:8px">ğŸ›¡ï¸</div>
      <div style="font-size:1.3rem;font-weight:700;color:#fff">ë³´í—˜ ê³ ê° ê´€ë¦¬</div>
      <div style="font-size:.82rem;color:rgba(255,255,255,.6);margin-top:4px">í´ë¼ìš°ë“œ ìë™ ë°±ì—… ë²„ì „</div>
    </div>
    <!-- íƒ­ -->
    <div style="display:flex;background:rgba(0,0,0,.2);border-radius:12px;padding:4px;margin-bottom:20px">
      <button id="tabLogin" class="auth-tab auth-tab-active" onclick="setAuthTab('login')">ë¡œê·¸ì¸</button>
      <button id="tabSignup" class="auth-tab" onclick="setAuthTab('signup')">íšŒì›ê°€ì…</button>
    </div>
    <!-- ë¡œê·¸ì¸ í¼ -->
    <div id="loginForm" style="display:flex;flex-direction:column;gap:12px">
      <input id="loginEmail" type="email" placeholder="ì´ë©”ì¼" class="auth-input" onkeydown="if(event.key==='Enter')document.getElementById('loginPw').focus()">
      <input id="loginPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="auth-input" onkeydown="if(event.key==='Enter')doLogin()">
      <div id="loginErr" style="color:#fca5a5;font-size:.82rem;min-height:16px;text-align:center"></div>
      <button id="btnLogin" onclick="doLogin()" class="auth-btn">ë¡œê·¸ì¸</button>
      <button onclick="showResetForm()" class="auth-link">ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?</button>
    </div>
    <!-- íšŒì›ê°€ì… í¼ -->
    <div id="signupForm" style="display:none;flex-direction:column;gap:12px">
      <input id="signupEmail" type="email" placeholder="ì´ë©”ì¼" class="auth-input">
      <input id="signupPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" class="auth-input">
      <input id="signupPw2" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" class="auth-input" onkeydown="if(event.key==='Enter')doSignup()">
      <div id="signupErr" style="color:#fca5a5;font-size:.82rem;min-height:16px;text-align:center"></div>
      <div id="signupSuccess" style="display:none;background:rgba(16,185,129,.2);border:1px solid rgba(16,185,129,.4);border-radius:10px;padding:12px;color:#6ee7b7;font-size:.85rem;text-align:center">
        âœ… ê°€ì… ì™„ë£Œ! ì´ë©”ì¼ ì¸ì¦ í›„ ë¡œê·¸ì¸í•˜ì„¸ìš”.<br><span style="font-size:.78rem;opacity:.8">(ì´ë©”ì¼ì´ ì•ˆ ì˜¤ë©´ ìŠ¤íŒ¸í•¨ í™•ì¸)</span>
      </div>
      <button id="btnSignup" onclick="doSignup()" class="auth-btn">íšŒì›ê°€ì…</button>
    </div>
    <!-- ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • í¼ -->
    <div id="resetForm" style="display:none;flex-direction:column;gap:12px">
      <div style="color:rgba(255,255,255,.8);font-size:.88rem;text-align:center">ê°€ì…í•œ ì´ë©”ì¼ë¡œ ì¬ì„¤ì • ë§í¬ë¥¼ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.</div>
      <input id="resetEmail" type="email" placeholder="ì´ë©”ì¼" class="auth-input">
      <div id="resetErr" style="color:#fca5a5;font-size:.82rem;min-height:16px;text-align:center"></div>
      <div id="resetSuccess" style="display:none;background:rgba(16,185,129,.2);border:1px solid rgba(16,185,129,.4);border-radius:10px;padding:12px;color:#6ee7b7;font-size:.85rem;text-align:center">
        âœ… ì¬ì„¤ì • ì´ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. í™•ì¸í•´ì£¼ì„¸ìš”.
      </div>
      <button id="btnReset" onclick="doResetPw()" class="auth-btn">ì¬ì„¤ì • ë©”ì¼ ë³´ë‚´ê¸°</button>
      <button onclick="hideResetForm()" class="auth-link">â† ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
  </div>
</div>
<style>
.auth-tab{flex:1;padding:9px;border:none;background:none;color:rgba(255,255,255,.6);font-size:.9rem;font-weight:600;border-radius:9px;cursor:pointer;font-family:inherit;transition:all .15s}
.auth-tab-active{background:#fff;color:#1e40af}
.auth-input{padding:13px 16px;border-radius:10px;border:1.5px solid rgba(255,255,255,.2);background:rgba(255,255,255,.1);color:#fff;font-size:.95rem;outline:none;font-family:inherit;transition:border-color .15s}
.auth-input:focus{border-color:rgba(255,255,255,.6)}
.auth-input::placeholder{color:rgba(255,255,255,.4)}
.auth-btn{padding:14px;border-radius:10px;border:none;background:#fff;color:#1e40af;font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit;transition:opacity .15s}
.auth-btn:hover{opacity:.9}
.auth-btn:disabled{opacity:.5;cursor:not-allowed}
.auth-link{background:none;border:none;color:rgba(255,255,255,.6);font-size:.82rem;cursor:pointer;text-align:center;padding:4px;font-family:inherit}
.auth-link:hover{color:rgba(255,255,255,.9)}
</style>

<!-- HEADER -->
<header class="app-header">
  <div class="app-logo">ğŸ›¡ï¸ ë³´í—˜ ê³ ê° ê´€ë¦¬</div>
  <span id="syncBadge" style="font-size:.68rem;color:rgba(255,255,255,.5);white-space:nowrap;margin-right:4px">â³</span>
  <div class="header-actions">
    <button class="icon-btn" onclick="exportExcel()" title="ì—‘ì…€ ë‚´ë³´ë‚´ê¸°">ğŸ“Š</button>
    <button class="icon-btn" onclick="openBackupModal()" title="ë°±ì—…/ë³µì›">ğŸ”’</button>
    <button class="icon-btn" onclick="window.print()" title="ì¸ì‡„">ğŸ–¨ï¸</button>
    <button id="logoutBtn" class="icon-btn" onclick="doLogout()" title="ë¡œê·¸ì•„ì›ƒ" style="display:none">ğŸšª</button>
  </div>
</header>

<div class="main-scroll">

  <!-- ALERT BAR -->
  <div class="alert-bar" id="alertBar">
    <span style="font-size:1rem">âš ï¸</span>
    <span class="alert-bar-text">ê°±ì‹  ì„ë°•:</span>
    <div id="alertItems" style="display:flex;flex-wrap:wrap"></div>
  </div>

  <!-- STATS -->
  <div class="stats-bar">
    <div class="stat-card"><div class="stat-icon blue">ğŸ‘¥</div><div><div class="stat-val" id="s-total">0</div><div class="stat-lbl">ì „ì²´ ê³ ê°</div></div></div>
    <div class="stat-card"><div class="stat-icon green">ğŸ“‹</div><div><div class="stat-val" id="s-contracts">0</div><div class="stat-lbl">ê³„ì•½ ê±´ìˆ˜</div></div></div>
    <div class="stat-card"><div class="stat-icon yellow">ğŸ””</div><div><div class="stat-val" id="s-renewal">0</div><div class="stat-lbl">30ì¼ ë‚´ ê°±ì‹ </div></div></div>
    <div class="stat-card"><div class="stat-icon red">ğŸ’°</div><div><div class="stat-val" id="s-premium">0</div><div class="stat-lbl">ì›”ë³´í—˜ë£Œ(ë§Œì›)</div></div></div>
  </div>

  <!-- TOOLBAR -->
  <div class="toolbar">
    <div class="search-box">ğŸ”<input type="text" id="searchInput" placeholder="ì´ë¦„Â·ì—°ë½ì²˜Â·ìƒí’ˆëª… ê²€ìƒ‰" oninput="applyFilter()"></div>
    <div class="view-toggle">
      <button class="view-btn active" id="vbCard" onclick="setView('card')">â˜°</button>
      <button class="view-btn" id="vbTable" onclick="setView('table')">âŠ</button>
    </div>
  </div>

  <!-- FILTER PILLS -->
  <div class="filter-pills">
    <div class="pill active" data-val="" onclick="setPill(this,'')">ì „ì²´</div>
    <div class="pill" data-val="ìœ íš¨" onclick="setPill(this,'ìœ íš¨')">âœ… ìœ íš¨</div>
    <div class="pill" data-val="ê°±ì‹ ì„ë°•" onclick="setPill(this,'ê°±ì‹ ì„ë°•')">âš ï¸ ê°±ì‹ ì„ë°•</div>
    <div class="pill" data-val="ë§Œê¸°" onclick="setPill(this,'ë§Œê¸°')">âŒ ë§Œê¸°</div>
  </div>

  <!-- CARD LIST -->
  <div class="card-list" id="cardList"></div>

  <!-- TABLE VIEW (hidden by default on mobile, visible on desktop switch) -->
  <div class="table-view" id="tableView">
    <div class="table-wrap">
      <table class="main-table">
        <thead>
          <tr>
            <th onclick="sortBy('name')">ì´ë¦„ â†•</th>
            <th>ì£¼ë¯¼ë²ˆí˜¸</th>
            <th>ì—°ë½ì²˜</th>
            <th>ì§ì—…</th>
            <th>ê°€ì¡±</th>
            <th>ë³´í—˜ ê³„ì•½</th>
            <th>ì°¨ëŸ‰ë²ˆí˜¸</th>
            <th>ì°¨ëŸ‰ê°±ì‹ </th>
            <th>ì‹¤ì†ê°±ì‹ </th>
            <th>ìƒíƒœ</th>
            <th>ë©”ëª¨</th>
            <th>ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <div id="emptyState" class="empty-state" style="display:none">
    <div class="empty-icon">ğŸ“‹</div>
    <div class="empty-text">ë“±ë¡ëœ ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤</div>
    <div class="empty-sub">ì•„ë˜ + ë²„íŠ¼ìœ¼ë¡œ ì²« ê³ ê°ì„ ë“±ë¡í•˜ì„¸ìš”</div>
  </div>

  <div class="pagination" id="pagination" style="display:none">
    <span class="page-count" id="pageInfo"></span>
    <div style="display:flex;gap:4px" id="pageBtns"></div>
  </div>

</div><!-- end main-scroll -->

<!-- BOTTOM BAR -->
<div class="bottom-bar">
  <button class="bottom-btn active" onclick="showTab('home')"><span class="bb-icon">ğŸ </span>í™ˆ</button>
  <button class="bottom-btn" onclick="showTab('search')"><span class="bb-icon">ğŸ”</span>ê²€ìƒ‰</button>
  <div style="width:56px"></div><!-- FAB placeholder -->
  <button class="bottom-btn" onclick="showTab('alert')"><span class="bb-icon">ğŸ””</span>ì•Œë¦¼</button>
  <button class="bottom-btn" onclick="openBackupModal()"><span class="bb-icon">ğŸ”’</span>ë°±ì—…/ë³µì›</button>
</div>
<button class="fab" onclick="openAddModal()">ï¼‹</button>

<!-- ADD/EDIT MODAL -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">ìƒˆ ê³ ê° ë“±ë¡</div>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">

      <div class="form-section">
        <div class="form-section-title">ğŸ‘¤ ê¸°ë³¸ ì •ë³´</div>
        <div class="form-grid">
          <div class="form-group"><label>ì´ë¦„ *</label><input type="text" id="f-name" placeholder="í™ê¸¸ë™" autocomplete="off"></div>
          <div class="form-group"><label>ì—°ë½ì²˜ *</label><input type="tel" id="f-phone" placeholder="010-0000-0000" oninput="formatPhone(this)" autocomplete="off"></div>
          <div class="form-group"><label>ìƒë…„ì›”ì¼</label><input type="date" id="f-birth"></div>
          <div class="form-group"><label>ì§ì—…</label><input type="text" id="f-job" placeholder="ì§ì—…" autocomplete="off"></div>
          <div class="form-group full"><label>ì£¼ë¯¼ë²ˆí˜¸</label>
            <div class="ssn-row">
              <input type="text" id="f-ssn1" placeholder="ì• 6ìë¦¬" maxlength="6" inputmode="numeric" oninput="this.value=this.value.replace(/\D/g,'')">
              <div class="ssn-dash">â€”</div>
              <input type="text" id="f-ssn2" placeholder="ë’¤ 7ìë¦¬" maxlength="7" inputmode="numeric" oninput="this.value=this.value.replace(/\D/g,'')">
            </div>
          </div>
          <div class="form-group full"><label>ì£¼ì†Œ</label><input type="text" id="f-address" placeholder="ì£¼ì†Œ" autocomplete="off"></div>
          <div class="form-group full"><label>ì´ë©”ì¼</label><input type="email" id="f-email" placeholder="email@example.com" autocomplete="off"></div>
        </div>
      </div>

      <div class="form-section">
        <div class="form-section-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ê°€ì¡±ê´€ê³„</div>
        <div class="dyn-block" id="familyBlock"></div>
        <button class="add-row-btn" onclick="addFamilyRow()">ï¼‹ ê°€ì¡± ì¶”ê°€</button>
      </div>

      <div class="form-section">
        <div class="form-section-title">ğŸ“‹ ë³´í—˜ ê³„ì•½ (ì—¬ëŸ¬ ê°œ ë“±ë¡ ê°€ëŠ¥)</div>
        <div class="dyn-block" id="insBlock"></div>
        <button class="add-row-btn" onclick="addInsRow()">ï¼‹ ë³´í—˜ ê³„ì•½ ì¶”ê°€</button>
      </div>

      <div class="form-section">
        <div class="form-section-title">ğŸš— ì°¨ëŸ‰ & ì‹¤ì†</div>
        <div class="form-grid-3">
          <div class="form-group"><label>ì°¨ëŸ‰ë²ˆí˜¸</label><input type="text" id="f-carPlate" placeholder="12ê°€ 3456" autocomplete="off"></div>
          <div class="form-group"><label>ì°¨ëŸ‰ ê°±ì‹ ì¼</label><input type="date" id="f-carRenewal"></div>
          <div class="form-group"><label>ì‹¤ì† ê°±ì‹ ì¼</label><input type="date" id="f-silseon"></div>
        </div>
      </div>

      <div class="form-section">
        <div class="form-section-title">ğŸ’¬ ìƒë‹´ ë©”ëª¨</div>
        <div class="memo-list" id="memoList"></div>
        <div class="memo-add-row">
          <textarea id="memoInput" placeholder="ìƒë‹´ ë‚´ìš©, íŠ¹ì´ì‚¬í•­..."></textarea>
          <button class="btn btn-outline" onclick="addMemo()">ë©”ëª¨ ì¶”ê°€</button>
        </div>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" style="flex:1" onclick="closeModal()">ì·¨ì†Œ</button>
      <button class="btn btn-primary" style="flex:2" onclick="saveCustomer()">ğŸ’¾ ì €ì¥</button>
    </div>
  </div>
</div>

<!-- BACKUP/RESTORE MODAL -->
<div class="modal-overlay" id="backupModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title">ğŸ”’ ë°±ì—… &amp; ë³µì›</div>
      <button class="modal-close" onclick="closeBackupModal()">âœ•</button>
    </div>
    <div class="modal-body">

      <!-- íƒ­ -->
      <div style="display:flex;gap:4px;background:var(--bg);border-radius:10px;padding:4px;margin-bottom:18px">
        <button id="tabExport" class="btab btab-active" onclick="setBackupTab('export')">ğŸ“¤ ë°±ì—… ì½”ë“œ ë§Œë“¤ê¸°</button>
        <button id="tabImport" class="btab" onclick="setBackupTab('import')">ğŸ“¥ ì½”ë“œë¡œ ë³µì›í•˜ê¸°</button>
      </div>

      <!-- ë°±ì—… íŒ¨ë„ -->
      <div id="exportPanel">
        <div style="background:var(--primary-bg);border-radius:10px;padding:14px;margin-bottom:14px">
          <div style="font-size:.8rem;font-weight:700;color:var(--primary);margin-bottom:6px">ğŸ“± í°ì„ ë°”ê¿€ ë•Œ ì´ë ‡ê²Œ í•˜ì„¸ìš”</div>
          <div style="font-size:.78rem;color:var(--muted);line-height:1.7">
            1. ì•„ë˜ ë°±ì—… ì½”ë“œë¥¼ <b>ë³µì‚¬</b>í•˜ì„¸ìš”<br>
            2. ì¹´ì¹´ì˜¤í†¡ <b>ë‚˜ì—ê²Œ ë³´ë‚´ê¸°</b>ë¡œ ì „ì†¡<br>
            3. ìƒˆ í°ì—ì„œ ì•± ì—´ê³  <b>ì½”ë“œë¡œ ë³µì›í•˜ê¸°</b> íƒ­<br>
            4. ì½”ë“œ ë¶™ì—¬ë„£ê¸° â†’ ë³µì› ì™„ë£Œ!
          </div>
        </div>
        <div style="font-size:.75rem;color:var(--muted);margin-bottom:6px;display:flex;justify-content:space-between;align-items:center">
          <span>ë°±ì—… ì½”ë“œ</span>
          <span id="backupInfo" style="color:var(--subtle)"></span>
        </div>
        <div class="backup-code-box" id="backupCodeBox" onclick="this.focus();document.execCommand('selectAll')"></div>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:12px">
          <button class="backup-action-btn" onclick="copyBackupCode()" style="background:var(--primary);color:#fff">
            ğŸ“‹ ë°±ì—… ì½”ë“œ ë³µì‚¬
          </button>
          <button class="backup-action-btn" onclick="shareBackupCode()" style="background:#25D366;color:#fff">
            ğŸ“¤ ì¹´ì¹´ì˜¤í†¡/ë¬¸ìë¡œ ê³µìœ 
          </button>
          <button class="backup-action-btn" onclick="exportExcel()" style="background:var(--surface2);color:var(--text);border:1px solid var(--border)">
            ğŸ“Š ì—‘ì…€ íŒŒì¼ë¡œë„ ë‚´ë³´ë‚´ê¸°
          </button>
        </div>
        <div style="margin-top:14px;padding:10px 12px;background:#fef9c3;border-radius:8px;border:1px solid #fde68a">
          <div style="font-size:.75rem;color:#92400e;font-weight:600">âš ï¸ ì£¼ì˜ì‚¬í•­</div>
          <div style="font-size:.73rem;color:#78350f;margin-top:3px;line-height:1.6">
            ë°±ì—… ì½”ë“œì—ëŠ” ëª¨ë“  ê³ ê° ì •ë³´ê°€ í¬í•¨ë©ë‹ˆë‹¤.<br>
            ë°˜ë“œì‹œ ë³¸ì¸ë§Œ ë³¼ ìˆ˜ ìˆëŠ” ê³³ì— ë³´ê´€í•˜ì„¸ìš”.
          </div>
        </div>
      </div>

      <!-- ë³µì› íŒ¨ë„ -->
      <div id="importPanel" style="display:none">
        <div style="background:var(--primary-bg);border-radius:10px;padding:14px;margin-bottom:14px">
          <div style="font-size:.8rem;font-weight:700;color:var(--primary);margin-bottom:4px">ğŸ“¥ ë³µì› ë°©ë²•</div>
          <div style="font-size:.78rem;color:var(--muted);line-height:1.7">
            ì¹´ì¹´ì˜¤í†¡ ë“±ì—ì„œ ì €ì¥í•´ë‘” ë°±ì—… ì½”ë“œë¥¼<br>ì•„ë˜ ì…ë ¥ì°½ì— ë¶™ì—¬ë„£ê³  ë³µì› ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.
          </div>
        </div>
        <label style="font-size:.75rem;font-weight:600;color:var(--muted);display:block;margin-bottom:6px">ë°±ì—… ì½”ë“œ ë¶™ì—¬ë„£ê¸°</label>
        <textarea class="restore-input" id="restoreInput" placeholder="INS1:eyJ...ë¡œ ì‹œì‘í•˜ëŠ” ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”"></textarea>
        <div id="restoreResult" style="font-size:.82rem;min-height:20px;margin-top:8px;text-align:center;font-weight:600"></div>
        <button class="backup-action-btn" onclick="doRestore()" style="background:var(--primary);color:#fff;margin-top:10px">
          ğŸ“¥ ì´ ì½”ë“œë¡œ ë°ì´í„° ë³µì›í•˜ê¸°
        </button>
        <div style="margin-top:12px;padding:10px 12px;background:#fee2e2;border-radius:8px;border:1px solid #fecaca">
          <div style="font-size:.75rem;color:#991b1b;font-weight:600">âš ï¸ ì£¼ì˜</div>
          <div style="font-size:.73rem;color:#7f1d1d;margin-top:3px;line-height:1.6">
            ë³µì›í•˜ë©´ í˜„ì¬ ê¸°ê¸°ì˜ ë°ì´í„°ê°€ êµì²´ë©ë‹ˆë‹¤.<br>
            ë³µì› ì „ì— í˜„ì¬ ê¸°ê¸° ë°±ì—… ì½”ë“œë¥¼ ë¨¼ì € ì €ì¥í•´ë‘ì„¸ìš”.
          </div>
        </div>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn btn-outline btn-full" onclick="closeBackupModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  âš™ï¸  Supabase ì„¤ì • â€” ë°œê¸‰ í›„ ì•„ë˜ ë‘ ì¤„ë§Œ ë°”ê¾¸ì„¸ìš”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL      = 'https://cqzaubldothptphbkech.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxemF1Ymxkb3RocHRwaGJrZWNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0OTk2MzgsImV4cCI6MjA4NzA3NTYzOH0.uUa9h9HoESZnxTLP70I33_AVGuu7gk5Ca3hpSSrNzHw';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SB_ON = SUPABASE_URL !== 'YOUR_SUPABASE_URL';

// â”€â”€ ë°ì´í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let customers = [];
let _session  = null;   // { access_token, user }
let editingId=null, currentMemos=[], currentFamily=[], currentIns=[];
let filteredData=[], sortKey='', sortAsc=true, currentPage=1, filterStatus='';
let currentView = 'card';
const PAGE = 20;
const LS_KEY = 'ins_crm_v4';
const LS_SES = 'ins_sb_session';

// â”€â”€ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function v(x){ return x || ''; }   // â† ì—‘ì…€ v() ë²„ê·¸ ìˆ˜ì •

// â”€â”€ Supabase REST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sbFetch(path, opt={}){
  const hdrs = {
    'Content-Type':'application/json',
    'apikey': SUPABASE_ANON_KEY,
    'Authorization':'Bearer '+(_session?_session.access_token:SUPABASE_ANON_KEY),
    ...opt.headers
  };
  const res = await fetch(SUPABASE_URL+path, {...opt, headers:hdrs});
  const txt = await res.text();
  const json = txt ? JSON.parse(txt) : {};
  if(!res.ok) throw new Error(json.error_description||json.message||JSON.stringify(json));
  return json;
}
async function sbSignIn(email,pw){
  return sbFetch('/auth/v1/token?grant_type=password',{method:'POST',body:JSON.stringify({email,password:pw})});
}
async function sbSignUp(email,pw){
  return sbFetch('/auth/v1/signup',{method:'POST',body:JSON.stringify({email,password:pw})});
}
async function sbSignOut(){
  try{ await sbFetch('/auth/v1/logout',{method:'POST'}); }catch(e){}
  _session=null; localStorage.removeItem(LS_SES);
}
async function sbResetPw(email){
  return sbFetch('/auth/v1/recover',{method:'POST',body:JSON.stringify({email})});
}
async function sbLoad(){
  const uid=_session.user.id;
  const rows=await sbFetch(`/rest/v1/customers?user_id=eq.${uid}&select=data`,{headers:{'Accept':'application/json'}});
  return (rows&&rows.length&&rows[0].data) ? rows[0].data : null;
}
async function sbSave(arr){
  const uid=_session.user.id;
  await sbFetch('/rest/v1/customers',{
    method:'POST',
    body:JSON.stringify({user_id:uid,data:arr,updated_at:new Date().toISOString()}),
    headers:{'Prefer':'resolution=merge-duplicates,return=minimal'}
  });
}

// â”€â”€ ì €ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function save(){
  // ë¡œì»¬ í•­ìƒ ì €ì¥ (ì˜¤í”„ë¼ì¸ ëŒ€ë¹„)
  try{ localStorage.setItem(LS_KEY, JSON.stringify(customers)); }catch(e){}
  // Supabase ì—°ë™ ì‹œ í´ë¼ìš°ë“œë„ ì €ì¥
  if(SB_ON && _session){
    sbSave(customers)
      .then(()=>updateSyncBadge('cloud'))
      .catch(()=>updateSyncBadge('error'));
  } else {
    updateSyncBadge('local');
  }
}
function loadLocal(){
  try{
    const raw=localStorage.getItem(LS_KEY);
    if(raw){const p=JSON.parse(raw);if(Array.isArray(p)&&p.length)return p;}
  }catch(e){}
  return null;
}
function updateSyncBadge(mode){
  const b=document.getElementById('syncBadge'); if(!b)return;
  const n=customers.length;
  if(mode==='cloud'){b.textContent=`â˜ï¸ ${n}ëª… ì €ì¥ë¨`;b.style.color='rgba(255,255,255,.85)';}
  else if(mode==='error'){b.textContent='âš ï¸ ì €ì¥ ì‹¤íŒ¨';b.style.color='#fca5a5';}
  else {b.textContent=`ğŸ’¾ ${n}ëª… ì €ì¥ë¨`;b.style.color='rgba(255,255,255,.6)';}
}

// â”€â”€ ì¸ì¦ í™”ë©´ í‘œì‹œ/ìˆ¨ê¹€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showAuthScreen(show){
  const el=document.getElementById('authScreen');
  if(el) el.style.display=show?'flex':'none';
  const ms=document.querySelector('.main-scroll');
  if(ms) ms.style.visibility=show?'hidden':'visible';
  const hd=document.querySelector('.app-header');
  if(hd) hd.style.display=show?'none':'flex';
  const bb=document.querySelector('.bottom-bar');
  if(bb) bb.style.display=show?'none':'flex';
  const fab=document.querySelector('.fab');
  if(fab) fab.style.display=show?'none':'flex';
}
function showLoadingScreen(show,msg){
  const el=document.getElementById('loadingScreen');if(!el)return;
  el.style.display=show?'flex':'none';
  const ms=document.querySelector('.main-scroll');if(ms)ms.style.visibility=show?'hidden':'visible';
  if(msg){const t=el.querySelector('.ld-msg');if(t)t.textContent=msg;}
}

// â”€â”€ ì¸ì¦ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setAuthTab(tab){
  document.getElementById('tabLogin').classList.toggle('auth-tab-active',tab==='login');
  document.getElementById('tabSignup').classList.toggle('auth-tab-active',tab==='signup');
  document.getElementById('loginForm').style.display=tab==='login'?'flex':'none';
  document.getElementById('signupForm').style.display=tab==='signup'?'flex':'none';
  document.getElementById('resetForm').style.display='none';
}
function showResetForm(){
  document.getElementById('loginForm').style.display='none';
  document.getElementById('resetForm').style.display='flex';
}
function hideResetForm(){ setAuthTab('login'); }

async function doLogin(){
  const email=document.getElementById('loginEmail').value.trim();
  const pw=document.getElementById('loginPw').value;
  const err=document.getElementById('loginErr');
  err.textContent='';
  if(!email||!pw){err.textContent='ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';return;}
  const btn=document.getElementById('btnLogin');
  btn.textContent='ë¡œê·¸ì¸ ì¤‘...';btn.disabled=true;
  try{
    const res=await sbSignIn(email,pw);
    _session={access_token:res.access_token,user:res.user};
    localStorage.setItem(LS_SES,JSON.stringify(_session));
    await afterLogin();
  }catch(e){
    err.textContent=e.message.includes('Invalid')?'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.':e.message;
  }finally{btn.textContent='ë¡œê·¸ì¸';btn.disabled=false;}
}
async function doSignup(){
  const email=document.getElementById('signupEmail').value.trim();
  const pw=document.getElementById('signupPw').value;
  const pw2=document.getElementById('signupPw2').value;
  const err=document.getElementById('signupErr');
  err.textContent='';
  if(!email||!pw){err.textContent='ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';return;}
  if(pw.length<6){err.textContent='ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';return;}
  if(pw!==pw2){err.textContent='ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';return;}
  const btn=document.getElementById('btnSignup');
  btn.textContent='ê°€ì… ì¤‘...';btn.disabled=true;
  try{
    const res=await sbSignUp(email,pw);
    if(res.access_token){
      _session={access_token:res.access_token,user:res.user};
      localStorage.setItem(LS_SES,JSON.stringify(_session));
      await afterLogin();
    } else {
      document.getElementById('signupSuccess').style.display='block';
    }
  }catch(e){
    err.textContent=e.message.includes('already')?'ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.':e.message;
  }finally{btn.textContent='íšŒì›ê°€ì…';btn.disabled=false;}
}
async function doResetPw(){
  const email=document.getElementById('resetEmail').value.trim();
  const err=document.getElementById('resetErr');
  err.textContent='';
  if(!email){err.textContent='ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.';return;}
  const btn=document.getElementById('btnReset');
  btn.textContent='ì „ì†¡ ì¤‘...';btn.disabled=true;
  try{
    await sbResetPw(email);
    document.getElementById('resetSuccess').style.display='block';
  }catch(e){err.textContent=e.message;}
  finally{btn.textContent='ì¬ì„¤ì • ë©”ì¼ ë³´ë‚´ê¸°';btn.disabled=false;}
}
async function doLogout(){
  if(!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  await sbSignOut();
  customers=[];
  showAuthScreen(true);
  document.getElementById('logoutBtn').style.display='none';
  updateSyncBadge('local');
  showToast('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤','warning');
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init(){
  // ë¬´ì¡°ê±´ ë¡œê·¸ì¸ í™”ë©´ ë¨¼ì € í‘œì‹œ
  showLoadingScreen(false);
  showAuthScreen(true);
}

async function afterLogin(){
  showLoadingScreen(true,'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
  showAuthScreen(false);
  try{
    const cloud=await sbLoad();
    if(cloud&&cloud.length>0){
      customers=cloud;
      localStorage.setItem(LS_KEY,JSON.stringify(customers));
    } else {
      const local=loadLocal();
      if(local&&local.length>0){ customers=local; await sbSave(customers); }
      else { loadSampleData(); await sbSave(customers); }
    }
    showLoadingScreen(false);
    const lb=document.getElementById('logoutBtn');
    if(lb) lb.style.display='flex';
    const sb=document.getElementById('syncBadge');
    if(sb&&_session) sb.title=_session.user.email;
    updateSyncBadge('cloud');
    applyFilter();updateStats();updateAlertBar();
  }catch(e){
    console.error('afterLogin error:',e);
    _session=null; localStorage.removeItem(LS_SES);
    showLoadingScreen(false);
    showAuthScreen(true);
    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤','warning');
  }
}

// â”€â”€ ë°±ì—… ì½”ë“œ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í˜•ì‹: base64(gzip-like) ë¡œ ì¸ì½”ë”©, ì•ì— "INS1:" prefix ë¶™ì„
function makeBackupCode(){
  const json = JSON.stringify(customers);
  // btoaëŠ” ASCIIë§Œ ì§€ì› â†’ UTF-8 â†’ í¼ì„¼íŠ¸ì¸ì½”ë”© â†’ btoa
  const b64 = btoa(unescape(encodeURIComponent(json)));
  return 'INS1:' + b64;
}
function parseBackupCode(code){
  const trimmed = code.trim();
  if(!trimmed.startsWith('INS1:')) throw new Error('ì˜¬ë°”ë¥¸ ë°±ì—… ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤.');
  const b64 = trimmed.slice(5);
  const json = decodeURIComponent(escape(atob(b64)));
  const arr = JSON.parse(json);
  if(!Array.isArray(arr)) throw new Error('ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
  return arr;
}

// â”€â”€ ë°±ì—… ëª¨ë‹¬ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openBackupModal(){
  document.getElementById('backupModal').classList.add('open');
  document.body.style.overflow = 'hidden';
  refreshBackupCode();
}
function closeBackupModal(){
  document.getElementById('backupModal').classList.remove('open');
  document.body.style.overflow = '';
  // ë³µì› íƒ­ ì´ˆê¸°í™”
  document.getElementById('restoreInput').value = '';
  document.getElementById('restoreResult').textContent = '';
  setBackupTab('export');
}
function setBackupTab(tab){
  document.getElementById('tabExport').classList.toggle('btab-active', tab==='export');
  document.getElementById('tabImport').classList.toggle('btab-active', tab==='import');
  document.getElementById('exportPanel').style.display = tab==='export'?'block':'none';
  document.getElementById('importPanel').style.display = tab==='import'?'block':'none';
}
function refreshBackupCode(){
  const code = makeBackupCode();
  const el = document.getElementById('backupCodeBox');
  if(el) el.textContent = code;
  const info = document.getElementById('backupInfo');
  if(info){
    const d = new Date().toLocaleString('ko-KR');
    info.textContent = `ê³ ê° ${customers.length}ëª… Â· ${d} ê¸°ì¤€`;
  }
}
function copyBackupCode(){
  const code = makeBackupCode();
  if(navigator.clipboard){
    navigator.clipboard.writeText(code).then(()=>showToast('ë°±ì—… ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ“‹','success'));
  } else {
    // fallback
    const ta = document.createElement('textarea');
    ta.value = code; ta.style.position='fixed'; ta.style.opacity='0';
    document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
    showToast('ë°±ì—… ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ“‹','success');
  }
}
function shareBackupCode(){
  const code = makeBackupCode();
  const text = `[ë³´í—˜ ê³ ê° ê´€ë¦¬ ë°±ì—…]
ê³ ê° ${customers.length}ëª…

${code}

â€» ìƒˆ ê¸°ê¸°ì—ì„œ ì•± ì—´ê³  ë°±ì—…/ë³µì› â†’ ì½”ë“œ ë¶™ì—¬ë„£ê¸°`;
  if(navigator.share){
    navigator.share({title:'ë³´í—˜ ê³ ê° ê´€ë¦¬ ë°±ì—…', text}).catch(()=>{});
  } else {
    if(navigator.clipboard){
      navigator.clipboard.writeText(text).then(()=>showToast('ê³µìœ  í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤','success'));
    }
  }
}
function doRestore(){
  const code = document.getElementById('restoreInput').value.trim();
  const resEl = document.getElementById('restoreResult');
  resEl.textContent=''; resEl.style.color='';
  if(!code){ resEl.textContent='ë°±ì—… ì½”ë“œë¥¼ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.'; resEl.style.color='#ef4444'; return; }
  try{
    const arr = parseBackupCode(code);
    // ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•© ì—¬ë¶€ í™•ì¸
    const msg = customers.length > 0
      ? `í˜„ì¬ ${customers.length}ëª…ì˜ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤.
ë°±ì—… ë°ì´í„°(${arr.length}ëª…)ë¡œ êµì²´í• ê¹Œìš”?

[í™•ì¸] êµì²´  [ì·¨ì†Œ] ì·¨ì†Œ`
      : null;
    if(msg && !confirm(msg)) return;
    customers = arr;
    save();
    applyFilter(); updateStats(); updateAlertBar();
    resEl.textContent = `âœ… ${arr.length}ëª…ì˜ ë°ì´í„°ê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!`;
    resEl.style.color = '#10b981';
    showToast(`${arr.length}ëª… ë³µì› ì™„ë£Œ!`, 'success');
    setTimeout(()=>closeBackupModal(), 1500);
  }catch(e){
    resEl.textContent = 'âŒ ' + e.message;
    resEl.style.color = '#ef4444';
  }
}

function showLoadingScreen(show){
  const el=document.getElementById('loadingScreen'); if(!el)return;
  el.style.display=show?'flex':'none';
  const ms=document.querySelector('.main-scroll'); if(ms)ms.style.visibility=show?'hidden':'visible';
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init(){
  const saved = loadLocal();
  if(saved){ customers = saved; }
  else { loadSampleData(); save(); }
  showLoadingScreen(false);
  applyFilter(); updateStats(); updateAlertBar(); updateSyncBadge();
}
function loadSampleData(){
  const d = n => new Date(Date.now()+n*86400000).toISOString().slice(0,10);
  customers = [
    {id:1001,name:'ê¹€ì² ìˆ˜(ìƒ˜í”Œ)',phone:'010-1234-5678',birth:'1980-05-15',
     ssn1:'800515',ssn2:'1234567',job:'íšŒì‚¬ì›',address:'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123',email:'kim@email.com',
     family:[{name:'ê¹€ì˜ìˆ™',rel:'ë°°ìš°ì',age:'45',phone:'010-2222-3333'},{name:'ê¹€ë¯¼ì¤€',rel:'ìë…€',age:'18',phone:'010-4444-5555'}],
     contracts:[
       {company:'ì‚¼ì„±ìƒëª…',product:'ì¢…ì‹ ë³´í—˜',startDate:'2020-01-01',expiry:'2040-01-01',premium:180000,payment:'ìë™ì´ì²´',payStatus:'ì •ìƒ'},
       {company:'í˜„ëŒ€í•´ìƒ',product:'ìš´ì „ìë³´í—˜',startDate:'2021-06-01',expiry:d(22),premium:35000,payment:'ìë™ì´ì²´',payStatus:'ì •ìƒ'}
     ],
     carPlate:'12ê°€ 3456',carRenewal:d(18),silseon:d(50),
     memos:[{date:'2024-01-15',text:'ğŸ‘‹ ìƒ˜í”Œì…ë‹ˆë‹¤. ì‚­ì œ í›„ ì‹¤ì œ ê³ ê°ì„ ë“±ë¡í•˜ì„¸ìš”!'}],
     createdAt:new Date().toISOString()},
    {id:1002,name:'ì´ì˜í¬(ìƒ˜í”Œ)',phone:'010-9876-5432',birth:'1975-11-20',
     ssn1:'751120',ssn2:'2345678',job:'ìì˜ì—…',address:'ë¶€ì‚°ì‹œ í•´ìš´ëŒ€êµ¬ ë‹¬ë§ì´ê¸¸ 456',email:'',
     family:[{name:'ì´ì¤€í˜',rel:'ë‚¨í¸',age:'52',phone:'010-6666-7777'}],
     contracts:[
       {company:'í¥êµ­ìƒëª…',product:'ì‹¤ì†ë³´í—˜',startDate:'2019-06-01',expiry:d(7),premium:95000,payment:'ì¹´ë“œ',payStatus:'ì •ìƒ'},
       {company:'KBì†í•´ë³´í—˜',product:'ì•”ë³´í—˜',startDate:'2022-03-01',expiry:'2042-03-01',premium:62000,payment:'ìë™ì´ì²´',payStatus:'ì •ìƒ'}
     ],
     carPlate:'34ë‚˜ 7890',carRenewal:'2025-08-15',silseon:d(7),
     memos:[{date:'2024-03-20',text:'ì‹¤ì† ê°±ì‹  ì•ˆë‚´ ì™„ë£Œ'}],
     createdAt:new Date().toISOString()}
  ];
}

// â”€â”€ STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function contractStatus(expiry){
  if(!expiry)return'ìœ íš¨';
  const d=Math.ceil((new Date(expiry)-Date.now())/86400000);
  if(d<0)return'ë§Œê¸°';if(d<=30)return'ê°±ì‹ ì„ë°•';return'ìœ íš¨';
}
function overallStatus(c){
  const ss=(c.contracts||[]).map(i=>contractStatus(i.expiry));
  if(ss.includes('ë§Œê¸°'))return'ë§Œê¸°';if(ss.includes('ê°±ì‹ ì„ë°•'))return'ê°±ì‹ ì„ë°•';return'ìœ íš¨';
}
function isAlert(dt){if(!dt)return false;const d=Math.ceil((new Date(dt)-Date.now())/86400000);return d>=0&&d<=30;}
function daysLeft(dt){if(!dt)return null;return Math.ceil((new Date(dt)-Date.now())/86400000);}

// â”€â”€ FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyFilter(){
  const q=document.getElementById('searchInput').value.toLowerCase();
  filteredData=customers.filter(c=>{
    const prods=(c.contracts||[]).map(i=>i.product+' '+i.company).join(' ');
    const fam=(c.family||[]).map(f=>f.name).join(' ');
    const matchQ=!q||[c.name,c.phone,c.job,c.address,prods,fam].some(v=>(v||'').toLowerCase().includes(q));
    const matchSt=!filterStatus||overallStatus(c)===filterStatus;
    return matchQ&&matchSt;
  });
  if(sortKey)filteredData.sort((a,b)=>sortAsc?(a[sortKey]||'').localeCompare(b[sortKey]||''):(b[sortKey]||'').localeCompare(a[sortKey]||''));
  currentPage=1;
  renderAll();
}
function sortBy(k){sortKey===k?sortAsc=!sortAsc:(sortKey=k,sortAsc=true);applyFilter();}
function setPill(el,val){
  document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');filterStatus=val;applyFilter();
}
function setView(v){
  currentView=v;
  document.getElementById('vbCard').classList.toggle('active',v==='card');
  document.getElementById('vbTable').classList.toggle('active',v==='table');
  document.getElementById('cardList').style.display=v==='card'?'flex':'none';
  document.getElementById('tableView').style.display=v==='table'?'block':'none';
  renderAll();
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll(){
  const total=filteredData.length;
  const empty=document.getElementById('emptyState');
  empty.style.display=total?'none':'block';
  document.getElementById('pagination').style.display=total>PAGE?'flex':'none';
  const pageData=filteredData.slice((currentPage-1)*PAGE,currentPage*PAGE);
  if(currentView==='card')renderCards(pageData);
  else renderTable(pageData);
  renderPagination(total);
}

// CARD
function renderCards(data){
  const list=document.getElementById('cardList');
  list.innerHTML='';
  data.forEach(c=>{
    const st=overallStatus(c);
    const bc=st==='ìœ íš¨'?'badge-active':st==='ê°±ì‹ ì„ë°•'?'badge-renewal':'badge-expired';
    const ini=c.name.charAt(0);
    const totalPrem=(c.contracts||[]).reduce((s,i)=>s+(Number(i.premium)||0),0);
    const carAl=isAlert(c.carRenewal),silAl=isAlert(c.silseon);

    // family
    const famHtml=(c.family||[]).length?`<div class="fam-pills">${(c.family||[]).map(f=>`
      <div class="fam-pill">
        <span class="fam-name">${f.name}</span><span class="fam-rel">${f.rel}</span>
        <span class="fam-info">${f.age}ì„¸ Â· ${f.phone?`<a class="tel-link" href="tel:${f.phone.replace(/\D/g,'')}" onclick="event.stopPropagation()">${f.phone}</a>`:'-'}</span>
      </div>`).join('')}</div>`:'<span style="font-size:.78rem;color:var(--subtle)">ë“±ë¡ëœ ê°€ì¡± ì—†ìŒ</span>';

    // insurance
    const insHtml=(c.contracts||[]).length?`<div class="ins-list">${(c.contracts||[]).map(ins=>{
      const ist=contractStatus(ins.expiry);const al=ist!=='ìœ íš¨';
      const dl=daysLeft(ins.expiry);
      const dlStr=dl!==null?(dl<0?'ë§Œê¸°':'D-'+dl):'';
      return`<div class="ins-row${al?' alert-ins':''}">
        <div class="ins-info">
          <div class="ins-name">${ins.company} Â· ${ins.product}${al?'<span class="alert-dot"></span>':''}</div>
          <div class="ins-detail">${ins.startDate||'-'} ~ ${ins.expiry||'-'}${dlStr?' <b style=color:var(--danger)>('+dlStr+')</b>':''} Â· ${ins.payment}</div>
        </div>
        <div class="ins-price">${ins.premium?Number(ins.premium).toLocaleString()+'ì›':'-'}</div>
      </div>`;
    }).join('')}${totalPrem?`<div class="ins-total">í•©ê³„: ${totalPrem.toLocaleString()}ì› / ì›”</div>`:''}</div>`
    :'<span style="font-size:.78rem;color:var(--subtle)">ê³„ì•½ ì—†ìŒ</span>';

    // car/silseon chips
    const chips=[];
    if(c.carPlate){chips.push(`<div class="info-chip${carAl?' alert-chip-red':''}"><span class="chip-label">ì°¨ëŸ‰</span><span class="chip-val">${c.carPlate}${carAl?'<span class="alert-dot"></span>':''}</span></div>`);}
    if(c.carRenewal){chips.push(`<div class="info-chip${carAl?' alert-chip-red':''}"><span class="chip-label">ì°¨ëŸ‰ê°±ì‹ </span><span class="chip-val">${c.carRenewal}</span></div>`);}
    if(c.silseon){chips.push(`<div class="info-chip${silAl?' alert-chip-red':''}"><span class="chip-label">ì‹¤ì†ê°±ì‹ </span><span class="chip-val">${c.silseon}${silAl?'<span class="alert-dot"></span>':''}</span></div>`);}

    const card=document.createElement('div');
    card.className='customer-card';
    card.innerHTML=`
      <div class="card-top">
        <div class="card-avatar">${ini}</div>
        <div class="card-main">
          <div class="card-name-row">
            <span class="card-name">${c.name}</span>
            <span class="badge ${bc}">${st}</span>
          </div>
          <div class="card-phone">${c.phone?`<a class="tel-link" href="tel:${c.phone.replace(/\D/g,'')}" onclick="event.stopPropagation()">ğŸ“ ${c.phone}</a>`:'-'}${c.job?' Â· '+c.job:''}</div>
          ${c.address?`<div class="card-job" style="margin-top:2px">${c.address}</div>`:''}
        </div>
      </div>
      ${(c.family||[]).length?`<div class="card-divider"></div>
      <div class="card-section">
        <div class="card-section-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ê°€ì¡±ê´€ê³„</div>
        ${famHtml}
      </div>`:''}
      <div class="card-divider"></div>
      <div class="card-section">
        <div class="card-section-title">ğŸ“‹ ë³´í—˜ ê³„ì•½</div>
        ${insHtml}
      </div>
      ${chips.length?`<div class="card-divider"></div>
      <div class="card-section">
        <div class="card-section-title">ğŸš— ì°¨ëŸ‰ & ì‹¤ì†</div>
        <div class="info-row">${chips.join('')}</div>
      </div>`:''}
      ${(c.memos||[]).length?`<div class="card-divider"></div>
      <div class="card-section">
        <div class="card-section-title">ğŸ’¬ ìµœê·¼ ë©”ëª¨</div>
        <div style="font-size:.82rem;color:var(--muted);background:var(--surface2);border-radius:8px;padding:8px 10px;border-left:3px solid var(--primary-light)">${(c.memos[0]||{}).text||''}</div>
        ${c.memos.length>1?`<div style="font-size:.72rem;color:var(--subtle);margin-top:4px">ì™¸ ${c.memos.length-1}ê°œ</div>`:''}
      </div>`:''}
      <div class="card-actions">
        <button class="btn btn-outline btn-sm" style="flex:1" onclick="event.stopPropagation();openEdit(${c.id})">âœï¸ ìˆ˜ì •</button>
        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();deleteCustomer(${c.id})">ğŸ—‘ï¸</button>
      </div>
    `;
    list.appendChild(card);
  });
}

// TABLE
function renderTable(data){
  const tb=document.getElementById('tableBody');tb.innerHTML='';
  data.forEach(c=>{
    const st=overallStatus(c);const bc=st==='ìœ íš¨'?'badge-active':st==='ê°±ì‹ ì„ë°•'?'badge-renewal':'badge-expired';
    const famH=(c.family||[]).map(f=>`<span class="badge badge-fam">${f.name}(${f.rel})</span>`).join(' ');
    const insH=(c.contracts||[]).length?`<div class="ins-mini">${(c.contracts||[]).map(ins=>{
      const al=contractStatus(ins.expiry)!=='ìœ íš¨';
      return`<div class="ins-mini-row${al?' alert':''}"><span class="co">${ins.company}</span>Â·${ins.product}Â·${ins.expiry||'-'}Â·${ins.premium?Number(ins.premium).toLocaleString()+'ì›':''}${al?'<span class="alert-dot"></span>':''}</div>`;
    }).join('')}<div class="ins-total-t">í•©ê³„ ${(c.contracts||[]).reduce((s,i)=>s+(Number(i.premium)||0),0).toLocaleString()}ì›/ì›”</div></div>`:'<span style="color:var(--subtle);font-size:.75rem">-</span>';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td style="font-weight:700">${c.name}</td>
      <td style="font-family:monospace;font-size:.78rem;color:var(--muted)">${c.ssn1?c.ssn1+'-â—â—â—â—â—â—â—':'-'}</td>
      <td style="font-size:.8rem;white-space:nowrap">${c.phone?`<a class="tel-link" href="tel:${c.phone.replace(/\D/g,'')}" onclick="event.stopPropagation()">ğŸ“ ${c.phone}</a>`:'-'}</td>
      <td>${c.job||'-'}</td>
      <td>${famH||'-'}</td>
      <td style="max-width:280px">${insH}</td>
      <td style="font-size:.8rem">${c.carPlate||'-'}${isAlert(c.carRenewal)?'<span class="alert-dot"></span>':''}</td>
      <td style="font-size:.79rem;white-space:nowrap">${c.carRenewal||'-'}</td>
      <td style="font-size:.79rem;white-space:nowrap">${c.silseon||'-'}${isAlert(c.silseon)?'<span class="alert-dot"></span>':''}</td>
      <td><span class="badge ${bc}">${st}</span></td>
      <td style="color:var(--muted);font-size:.79rem">${(c.memos||[]).length?'ğŸ’¬'+(c.memos||[]).length:'-'}</td>
      <td style="white-space:nowrap">
        <button class="btn btn-outline btn-sm" onclick="event.stopPropagation();openEdit(${c.id})">âœï¸</button>
        <button class="btn btn-danger btn-sm" style="margin-left:3px" onclick="event.stopPropagation();deleteCustomer(${c.id})">ğŸ—‘ï¸</button>
      </td>`;
    tr.onclick=()=>openEdit(c.id);
    tb.appendChild(tr);
  });
}

function renderPagination(total){
  const tp=Math.ceil(total/PAGE);
  document.getElementById('pageInfo').textContent=`ì´ ${total}ëª…`;
  const b=document.getElementById('pageBtns');b.innerHTML='';
  for(let i=1;i<=Math.min(tp,8);i++){
    const btn=document.createElement('button');
    btn.className='page-btn'+(i===currentPage?' active':'');
    btn.textContent=i;btn.onclick=()=>{currentPage=i;renderAll();};
    b.appendChild(btn);
  }
}

function updateStats(){
  document.getElementById('s-total').textContent=customers.length;
  document.getElementById('s-contracts').textContent=customers.reduce((s,c)=>s+(c.contracts||[]).length,0);
  document.getElementById('s-renewal').textContent=customers.filter(c=>overallStatus(c)==='ê°±ì‹ ì„ë°•').length;
  const tot=customers.reduce((s,c)=>s+(c.contracts||[]).reduce((ss,i)=>ss+(Number(i.premium)||0),0),0);
  document.getElementById('s-premium').textContent=(tot/10000).toFixed(1);
}

function updateAlertBar(){
  const bar=document.getElementById('alertBar');
  const al=customers.filter(c=>overallStatus(c)!=='ìœ íš¨'||isAlert(c.carRenewal)||isAlert(c.silseon));
  if(!al.length){bar.classList.remove('show');return;}
  bar.classList.add('show');
  document.getElementById('alertItems').innerHTML=al.map(c=>`<span class="alert-chip">${c.name}</span>`).join('');
}

// â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddModal(){
  editingId=null;currentMemos=[];currentFamily=[];currentIns=[];
  document.getElementById('modalTitle').textContent='ìƒˆ ê³ ê° ë“±ë¡';
  clearForm();renderFamilyBlock();renderInsBlock();renderMemoList();
  document.getElementById('addModal').classList.add('open');
  document.body.style.overflow='hidden';
}
function openEdit(id){
  const c=customers.find(x=>x.id===id);if(!c)return;
  editingId=id;
  currentMemos=JSON.parse(JSON.stringify(c.memos||[]));
  currentFamily=JSON.parse(JSON.stringify(c.family||[]));
  currentIns=JSON.parse(JSON.stringify(c.contracts||[]));
  document.getElementById('modalTitle').textContent=`âœï¸ ${c.name} ìˆ˜ì •`;
  fillForm(c);renderFamilyBlock();renderInsBlock();renderMemoList();
  document.getElementById('addModal').classList.add('open');
  document.body.style.overflow='hidden';
}
function closeModal(){
  document.getElementById('addModal').classList.remove('open');
  document.body.style.overflow='';
}
function clearForm(){
  ['name','phone','birth','ssn1','ssn2','job','address','email','carPlate','carRenewal','silseon','memoInput']
    .forEach(f=>{const el=document.getElementById('f-'+f);if(el)el.value='';});
}
function fillForm(c){
  const s=(id,v)=>{const el=document.getElementById('f-'+id);if(el)el.value=v||'';};
  s('name',c.name);s('phone',c.phone);s('birth',c.birth);
  s('ssn1',c.ssn1);s('ssn2',c.ssn2);s('job',c.job);
  s('address',c.address);s('email',c.email);
  s('carPlate',c.carPlate);s('carRenewal',c.carRenewal);s('silseon',c.silseon);
}
function saveCustomer(){
  const g=id=>(document.getElementById('f-'+id)||{}).value||'';
  const data={name:g('name'),phone:g('phone'),birth:g('birth'),ssn1:g('ssn1'),ssn2:g('ssn2'),job:g('job'),address:g('address'),email:g('email'),carPlate:g('carPlate'),carRenewal:g('carRenewal'),silseon:g('silseon'),family:collectFamily(),contracts:collectIns(),memos:currentMemos};
  if(!data.name.trim()){showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”','warning');return;}
  if(editingId){
    const i=customers.findIndex(c=>c.id===editingId);customers[i]={...customers[i],...data};
    showToast(`${data.name} ìˆ˜ì • ì™„ë£Œ`,'success');
  }else{
    customers.push({...data,id:Date.now(),createdAt:new Date().toISOString()});
    showToast(`${data.name} ë“±ë¡ ì™„ë£Œ`,'success');
  }
  save();closeModal();applyFilter();updateAlertBar();updateStats();
}
function deleteCustomer(id){
  const c=customers.find(x=>x.id===id);
  if(!confirm(`${c.name} ê³ ê°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
  customers=customers.filter(x=>x.id!==id);
  save();applyFilter();updateAlertBar();updateStats();
  showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤','warning');
}

// â”€â”€ FAMILY (card style) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const RELS=['ë°°ìš°ì','ë‚¨í¸','ì•„ë‚´','ìë…€','ì•„ë“¤','ë”¸','ì•„ë²„ì§€','ì–´ë¨¸ë‹ˆ','í˜•','ì˜¤ë¹ ','ì–¸ë‹ˆ','ëˆ„ë‚˜','ë™ìƒ','ê¸°íƒ€'];
function addFamilyRow(){currentFamily.push({name:'',rel:'ë°°ìš°ì',age:'',phone:''});renderFamilyBlock();}
function delFamilyRow(i){currentFamily.splice(i,1);renderFamilyBlock();}
function collectFamily(){
  return currentFamily.map((_,i)=>({
    name:(document.getElementById(`fn-${i}`)||{}).value||'',
    rel:(document.getElementById(`fr-${i}`)||{}).value||'',
    age:(document.getElementById(`fa-${i}`)||{}).value||'',
    phone:(document.getElementById(`fp-${i}`)||{}).value||''
  })).filter(f=>f.name);
}
function renderFamilyBlock(){
  const b=document.getElementById('familyBlock');
  if(!currentFamily.length){b.innerHTML='<div style="text-align:center;padding:12px;color:var(--subtle);font-size:.8rem;border:1.5px dashed var(--border);border-radius:9px">ê°€ì¡±ì„ ì¶”ê°€í•˜ì„¸ìš”</div>';return;}
  b.innerHTML=currentFamily.map((f,i)=>`
    <div class="dyn-row">
      <button class="del-row-btn" onclick="delFamilyRow(${i})">âœ•</button>
      <div class="dyn-row-grid" style="padding-right:32px">
        <div class="form-group"><label>ì´ë¦„</label><input id="fn-${i}" type="text" value="${f.name}" placeholder="í™ê¸¸ë™" autocomplete="off"></div>
        <div class="form-group"><label>ê´€ê³„</label><select id="fr-${i}">${RELS.map(r=>`<option${f.rel===r?' selected':''}>${r}</option>`).join('')}</select></div>
        <div class="form-group"><label>ë‚˜ì´</label><input id="fa-${i}" type="number" value="${f.age}" placeholder="ë‚˜ì´" inputmode="numeric" min="0" max="120"></div>
        <div class="form-group"><label>ì „í™”ë²ˆí˜¸</label><input id="fp-${i}" type="tel" value="${f.phone}" placeholder="010-0000-0000"></div>
      </div>
    </div>`).join('');
}

// â”€â”€ INSURANCE (card style) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addInsRow(){currentIns.push({company:'',product:'',startDate:'',expiry:'',premium:'',payment:'ìë™ì´ì²´',payStatus:'ì •ìƒ'});renderInsBlock();}
function delInsRow(i){currentIns.splice(i,1);renderInsBlock();}
function collectIns(){
  return currentIns.map((_,i)=>({
    company:(document.getElementById(`ic-${i}`)||{}).value||'',
    product:(document.getElementById(`ip-${i}`)||{}).value||'',
    startDate:(document.getElementById(`is-${i}`)||{}).value||'',
    expiry:(document.getElementById(`ie-${i}`)||{}).value||'',
    premium:Number((document.getElementById(`im-${i}`)||{}).value)||0,
    payment:(document.getElementById(`iw-${i}`)||{}).value||'',
    payStatus:(document.getElementById(`it-${i}`)||{}).value||''
  })).filter(ins=>ins.company||ins.product);
}
function renderInsBlock(){
  const b=document.getElementById('insBlock');
  if(!currentIns.length){b.innerHTML='<div style="text-align:center;padding:12px;color:var(--subtle);font-size:.8rem;border:1.5px dashed var(--border);border-radius:9px">ë³´í—˜ ê³„ì•½ì„ ì¶”ê°€í•˜ì„¸ìš”</div>';return;}
  b.innerHTML=currentIns.map((ins,i)=>`
    <div class="dyn-row">
      <button class="del-row-btn" onclick="delInsRow(${i})">âœ•</button>
      <div style="font-size:.72rem;font-weight:700;color:var(--primary);margin-bottom:8px;padding-right:32px">ê³„ì•½ ${i+1}</div>
      <div class="dyn-row-grid ins-grid" style="padding-right:4px">
        <div class="form-group"><label>ë³´í—˜ì‚¬</label><input id="ic-${i}" type="text" value="${ins.company}" placeholder="ì‚¼ì„±ìƒëª…" autocomplete="off"></div>
        <div class="form-group"><label>ìƒí’ˆëª…</label><input id="ip-${i}" type="text" value="${ins.product}" placeholder="ì¢…ì‹ ë³´í—˜" autocomplete="off"></div>
        <div class="form-group"><label>ì›” ë³´í—˜ë£Œ(ì›)</label><input id="im-${i}" type="number" value="${ins.premium||''}" placeholder="150000" inputmode="numeric"></div>
        <div class="form-group"><label>ì‹œì‘ì¼</label><input id="is-${i}" type="date" value="${ins.startDate}"></div>
        <div class="form-group"><label>ê°±ì‹ /ë§Œê¸°ì¼</label><input id="ie-${i}" type="date" value="${ins.expiry}"></div>
        <div class="form-group"><label>ë‚©ì…ë°©ë²•</label><select id="iw-${i}">${['ìë™ì´ì²´','ì¹´ë“œ','í˜„ê¸ˆ'].map(p=>`<option${ins.payment===p?' selected':''}>${p}</option>`).join('')}</select></div>
        <div class="form-group"><label>ë‚©ì…ìƒíƒœ</label><select id="it-${i}">${['ì •ìƒ','ì—°ì²´','ì™„ë‚©'].map(p=>`<option${ins.payStatus===p?' selected':''}>${p}</option>`).join('')}</select></div>
      </div>
    </div>`).join('');
}

// â”€â”€ MEMO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addMemo(){
  const inp=document.getElementById('memoInput');const t=inp.value.trim();if(!t)return;
  currentMemos.unshift({date:new Date().toLocaleDateString('ko-KR'),text:t});
  inp.value='';renderMemoList();
}
function deleteMemo(i){currentMemos.splice(i,1);renderMemoList();}
function renderMemoList(){
  document.getElementById('memoList').innerHTML=currentMemos.map((m,i)=>`
    <div class="memo-item">
      <div class="memo-date">${m.date}</div>
      <div class="memo-text">${m.text}</div>
      <button class="memo-del" onclick="deleteMemo(${i})">âœ•</button>
    </div>`).join('');
}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatPhone(el){
  let v=el.value.replace(/\D/g,'');
  el.value=v.length<=7?v.replace(/(\d{3})(\d{0,4})/,'$1-$2'):v.replace(/(\d{3})(\d{4})(\d{0,4})/,'$1-$2-$3');
}
function showToast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className=`toast ${type} show`;
  setTimeout(()=>t.className='toast',2800);
}
function showTab(tab){
  if(tab==='search'){document.getElementById('searchInput').focus();}
  if(tab==='alert'){const al=document.getElementById('alertBar');if(al.classList.contains('show'))al.scrollIntoView({behavior:'smooth'});}
}
/* â”€â”€ ìˆœìˆ˜ JSë¡œ xlsx ìƒì„± (ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆí•„ìš”) â”€â”€ */
function exportExcel(){
  try{
    // SST (ê³µìœ  ë¬¸ìì—´) ì´ˆê¸°í™”
    const _sst=[], _sstMap={};
    function _si(s){
      const k=String(s);
      if(_sstMap[k]===undefined){_sstMap[k]=_sst.length;_sst.push(k);}
      return _sstMap[k];
    }
    function _esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
    function _col(n){let s='';n++;while(n>0){s=String.fromCharCode(64+(n%26||26))+s;n=Math.floor((n-1)/26);}return s;}

    // ì›Œí¬ì‹œíŠ¸ XML ìƒì„±
    function makeWs(rows, widths, statusColIdx){
      let x='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>';
      x+='<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">';
      x+='<sheetViews><sheetView tabSelected="1" workbookViewId="0"/></sheetViews>';
      if(widths){
        x+='<cols>';
        widths.forEach((w,i)=>{x+=`<col min="${i+1}" max="${i+1}" width="${w}" customWidth="1"/>`;});
        x+='</cols>';
      }
      x+='<sheetData>';
      rows.forEach((row,ri)=>{
        // í–‰ ìƒ‰ìƒ: ìƒíƒœ ì»¬ëŸ¼ ê¸°ì¤€
        let rowS=0;
        if(ri>0 && statusColIdx!=null && row[statusColIdx]){
          const st=row[statusColIdx];
          if(st==='ê°±ì‹ ì„ë°•') rowS=2;
          else if(st==='ë§Œê¸°') rowS=3;
        }
        x+=`<row r="${ri+1}">`;
        row.forEach((cell,ci)=>{
          const ref=`${_col(ci)}${ri+1}`;
          if(cell===null||cell===undefined||cell===''){
            x+=`<c r="${ref}" s="${ri===0?1:rowS}"/>`;
          } else if(typeof cell==='number'){
            const s=ri===0?1:(rowS||4);
            x+=`<c r="${ref}" s="${s}" t="n"><v>${cell}</v></c>`;
          } else {
            const s=ri===0?1:rowS;
            x+=`<c r="${ref}" s="${s}" t="s"><v>${_si(cell)}</v></c>`;
          }
        });
        x+='</row>';
      });
      x+='</sheetData>';
      x+='<pageMargins left="0.7" right="0.7" top="0.75" bottom="0.75" header="0.3" footer="0.3"/>';
      x+='</worksheet>';
      return x;
    }

    // â”€â”€ ë°ì´í„° ìˆ˜ì§‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const h1=['ì´ë¦„','ì—°ë½ì²˜','ìƒë…„ì›”ì¼','ì£¼ë¯¼ë²ˆí˜¸','ì§ì—…','ì£¼ì†Œ',
      'ê°€ì¡±ê´€ê³„','ë³´í—˜ì‚¬','ìƒí’ˆëª…','ì‹œì‘ì¼','ë§Œê¸°/ê°±ì‹ ì¼','ì›”ë³´í—˜ë£Œ(ì›)',
      'ë‚©ì…ë°©ë²•','ë‚©ì…ìƒíƒœ','ì°¨ëŸ‰ë²ˆí˜¸','ì°¨ëŸ‰ê°±ì‹ ì¼','ì‹¤ì†ê°±ì‹ ì¼','ìƒíƒœ','ë©”ëª¨ìˆ˜'];
    const r1=[h1];
    customers.forEach(c=>{
      const base=[v(c.name),v(c.phone),v(c.birth),
        c.ssn1?c.ssn1+'-'+c.ssn2:'',v(c.job),v(c.address)];
      const fam=(c.family||[]).map(f=>`${f.name}(${f.rel}Â·${f.age}ì„¸)`).join(' / ');
      const ins=c.contracts||[];
      const st=overallStatus(c);
      if(!ins.length){
        r1.push([...base,fam,'','','','','','','',v(c.carPlate),v(c.carRenewal),v(c.silseon),st,(c.memos||[]).length]);
      } else {
        ins.forEach((i,idx)=>{
          r1.push([
            ...(idx===0?base:Array(6).fill('')),
            idx===0?fam:'',
            v(i.company),v(i.product),v(i.startDate),v(i.expiry),
            i.premium?Number(i.premium):'',
            v(i.payment),v(i.payStatus),
            idx===0?v(c.carPlate):'',idx===0?v(c.carRenewal):'',idx===0?v(c.silseon):'',
            idx===0?st:'',idx===0?(c.memos||[]).length:''
          ]);
        });
      }
    });

    const h2=['ê³ ê° ì´ë¦„','ê°€ì¡± ì´ë¦„','ê´€ê³„','ë‚˜ì´','ì „í™”ë²ˆí˜¸'];
    const r2=[h2];
    customers.forEach(c=>(c.family||[]).forEach(f=>
      r2.push([v(c.name),v(f.name),v(f.rel),f.age?Number(f.age):'',v(f.phone)])));

    const h3=['ê³ ê° ì´ë¦„','ì—°ë½ì²˜','ë‚ ì§œ','ë©”ëª¨ ë‚´ìš©'];
    const r3=[h3];
    customers.forEach(c=>(c.memos||[]).forEach(m=>
      r3.push([v(c.name),v(c.phone),v(m.date),v(m.text)])));

    const h4=['ì´ë¦„','ì—°ë½ì²˜','êµ¬ë¶„','ìƒí’ˆ/í•­ëª©','ê°±ì‹ ì¼','D-Day'];
    const r4=[h4];
    customers.forEach(c=>{
      (c.contracts||[]).forEach(i=>{
        const d=i.expiry?Math.ceil((new Date(i.expiry)-Date.now())/86400000):null;
        if(d!==null&&d>=0&&d<=60)
          r4.push([v(c.name),v(c.phone),'ë³´í—˜ê³„ì•½',`${v(i.company)} ${v(i.product)}`,v(i.expiry),'D-'+d]);
      });
      let d=c.carRenewal?Math.ceil((new Date(c.carRenewal)-Date.now())/86400000):null;
      if(d!==null&&d>=0&&d<=60) r4.push([v(c.name),v(c.phone),'ì°¨ëŸ‰ê°±ì‹ ','',v(c.carRenewal),'D-'+d]);
      d=c.silseon?Math.ceil((new Date(c.silseon)-Date.now())/86400000):null;
      if(d!==null&&d>=0&&d<=60) r4.push([v(c.name),v(c.phone),'ì‹¤ì†ê°±ì‹ ','',v(c.silseon),'D-'+d]);
    });

    // â”€â”€ ì›Œí¬ì‹œíŠ¸ ìƒì„± (SSTì— ë¬¸ìì—´ ë“±ë¡ë¨) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ws1=makeWs(r1,[10,14,12,16,10,24,28,12,14,12,12,12,10,8,12,12,12,8,6],17);
    const ws2=makeWs(r2,[12,12,10,6,14],null);
    const ws3=makeWs(r3,[12,14,14,60],null);
    const ws4=makeWs(r4,[10,14,10,22,12,8],null);

    // â”€â”€ SST XML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let ssXml='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>';
    ssXml+=`<sst xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" count="${_sst.length}" uniqueCount="${_sst.length}">`;
    _sst.forEach(s=>{ssXml+=`<si><t xml:space="preserve">${_esc(s)}</t></si>`;});
    ssXml+='</sst>';

    // â”€â”€ ìŠ¤íƒ€ì¼ XML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const stylesXml='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>'
      +'<styleSheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">'
      +'<fonts count="2">'
      +'<font><sz val="10"/><name val="ë§‘ì€ ê³ ë”•"/></font>'
      +'<font><b/><sz val="10"/><name val="ë§‘ì€ ê³ ë”•"/><color rgb="FFFFFFFF"/></font>'
      +'</fonts>'
      +'<fills count="5">'
      +'<fill><patternFill patternType="none"/></fill>'
      +'<fill><patternFill patternType="gray125"/></fill>'
      +'<fill><patternFill patternType="solid"><fgColor rgb="FF1E40AF"/></patternFill></fill>'
      +'<fill><patternFill patternType="solid"><fgColor rgb="FFFFFBEB"/></patternFill></fill>'
      +'<fill><patternFill patternType="solid"><fgColor rgb="FFFEE2E2"/></patternFill></fill>'
      +'</fills>'
      +'<borders count="2">'
      +'<border><left/><right/><top/><bottom/><diagonal/></border>'
      +'<border>'
      +'<left style="thin"><color rgb="FFD1D5DB"/></left>'
      +'<right style="thin"><color rgb="FFD1D5DB"/></right>'
      +'<top style="thin"><color rgb="FFD1D5DB"/></top>'
      +'<bottom style="thin"><color rgb="FFD1D5DB"/></bottom>'
      +'<diagonal/></border>'
      +'</borders>'
      +'<cellStyleXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0"/></cellStyleXfs>'
      +'<cellXfs count="5">'
      +'<xf numFmtId="0" fontId="0" fillId="0" borderId="1" xfId="0"/>'
      +'<xf numFmtId="0" fontId="1" fillId="2" borderId="1" xfId="0"><alignment horizontal="center" vertical="center" wrapText="1"/></xf>'
      +'<xf numFmtId="0" fontId="0" fillId="3" borderId="1" xfId="0"/>'
      +'<xf numFmtId="0" fontId="0" fillId="4" borderId="1" xfId="0"/>'
      +'<xf numFmtId="3" fontId="0" fillId="0" borderId="1" xfId="0"><alignment horizontal="right"/></xf>'
      +'</cellXfs>'
      +'<cellStyles count="1"><cellStyle name="Normal" xfId="0" builtinId="0"/></cellStyles>'
      +'</styleSheet>';

    // â”€â”€ ZIP ì¡°ë¦½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const files={
      '[Content_Types].xml':'<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types"><Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/><Default Extension="xml" ContentType="application/xml"/><Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/><Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/><Override PartName="/xl/worksheets/sheet2.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/><Override PartName="/xl/worksheets/sheet3.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/><Override PartName="/xl/worksheets/sheet4.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/><Override PartName="/xl/sharedStrings.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml"/><Override PartName="/xl/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml"/></Types>',
      '_rels/.rels':'<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/></Relationships>',
      'xl/workbook.xml':'<?xml version="1.0" encoding="UTF-8" standalone="yes"?><workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"><bookViews><workbookView xWindow="0" yWindow="0" windowWidth="14400" windowHeight="8100"/></bookViews><sheets><sheet name="ê³ ê° ëª©ë¡" sheetId="1" r:id="rId1"/><sheet name="ê°€ì¡±ê´€ê³„" sheetId="2" r:id="rId2"/><sheet name="ìƒë‹´ ë©”ëª¨" sheetId="3" r:id="rId3"/><sheet name="ê°±ì‹ ì•Œë¦¼(60ì¼)" sheetId="4" r:id="rId4"/></sheets></workbook>',
      'xl/_rels/workbook.xml.rels':'<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/><Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet2.xml"/><Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet3.xml"/><Relationship Id="rId4" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet4.xml"/><Relationship Id="rId5" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/sharedStrings" Target="sharedStrings.xml"/><Relationship Id="rId6" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/></Relationships>',
      'xl/styles.xml':stylesXml,
      'xl/sharedStrings.xml':ssXml,
      'xl/worksheets/sheet1.xml':ws1,
      'xl/worksheets/sheet2.xml':ws2,
      'xl/worksheets/sheet3.xml':ws3,
      'xl/worksheets/sheet4.xml':ws4,
    };

    // â”€â”€ ZIP ë¹Œë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function _s2u8(s){
      const out=[];
      for(let i=0;i<s.length;i++){
        const c=s.charCodeAt(i);
        if(c<0x80) out.push(c);
        else if(c<0x800) out.push(0xC0|(c>>6),0x80|(c&0x3F));
        else out.push(0xE0|(c>>12),0x80|((c>>6)&0x3F),0x80|(c&0x3F));
      }
      return new Uint8Array(out);
    }
    function _crc32(buf){
      let crc=0xFFFFFFFF;
      const t=[];
      for(let i=0;i<256;i++){let c=i;for(let j=0;j<8;j++)c=c&1?(0xEDB88320^(c>>>1)):(c>>>1);t[i]=c;}
      for(const b of buf)crc=t[(crc^b)&0xFF]^(crc>>>8);
      return(crc^0xFFFFFFFF)>>>0;
    }
    function _u16(n){const b=new Uint8Array(2);new DataView(b.buffer).setUint16(0,n,true);return b;}
    function _u32(n){const b=new Uint8Array(4);new DataView(b.buffer).setUint32(0,n,true);return b;}
    function _cat(arr){const t=arr.reduce((s,a)=>s+a.length,0);const o=new Uint8Array(t);let p=0;arr.forEach(a=>{o.set(a,p);p+=a.length;});return o;}

    const parts=[],cdir=[];let offset=0;
    for(const[path,content] of Object.entries(files)){
      const nb=_s2u8(path);
      const data=_s2u8(content);
      const crc=_crc32(data);
      const lh=_cat([new Uint8Array([0x50,0x4B,0x03,0x04]),_u16(20),_u16(0),_u16(0),_u16(0),_u16(0),_u32(crc),_u32(data.length),_u32(data.length),_u16(nb.length),_u16(0),nb]);
      parts.push(lh,data);
      cdir.push(_cat([new Uint8Array([0x50,0x4B,0x01,0x02]),_u16(20),_u16(20),_u16(0),_u16(0),_u16(0),_u16(0),_u32(crc),_u32(data.length),_u32(data.length),_u16(nb.length),_u16(0),_u16(0),_u16(0),_u16(0),_u32(0),_u32(offset),nb]));
      offset+=lh.length+data.length;
    }
    const cd=_cat(cdir);
    const eocd=_cat([new Uint8Array([0x50,0x4B,0x05,0x06]),_u16(0),_u16(0),_u16(Object.keys(files).length),_u16(Object.keys(files).length),_u32(cd.length),_u32(offset),_u16(0)]);
    const blob=new Blob([_cat([...parts,cd,eocd])],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});

    const today=new Date().toISOString().slice(0,10);
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=`ë³´í—˜ê³ ê°ëª©ë¡_${today}.xlsx`;
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    setTimeout(()=>URL.revokeObjectURL(a.href),5000);
    showToast('ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ ğŸ“Š','success');
  }catch(e){
    console.error(e);
    showToast('ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜: '+e.message,'warning');
  }
}



// â”€â”€ EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){closeModal();closeBackupModal();}
  if((e.ctrlKey||e.metaKey)&&e.key==='n'){e.preventDefault();openAddModal();}
});
document.getElementById('addModal').addEventListener('click',function(e){if(e.target===this)closeModal();});
document.getElementById('backupModal').addEventListener('click',function(e){if(e.target===this)closeBackupModal();});

// ìŠ¤ì™€ì´í”„ë¡œ ëª¨ë‹¬ ë‹«ê¸°
let touchStartY=0;
document.querySelectorAll('.modal').forEach(m=>{
  m.addEventListener('touchstart',e=>{touchStartY=e.touches[0].clientY;},{passive:true});
  m.addEventListener('touchmove',e=>{
    if(e.touches[0].clientY-touchStartY>80&&m.scrollTop===0){closeModal();closeBackupModal();}
  },{passive:true});
});

init();
</script>
</body>
</html>
